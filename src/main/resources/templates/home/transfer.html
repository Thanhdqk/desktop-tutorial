<!DOCTYPE html>
<html lang="en" xmlns="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Transfer NFTs</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.16.0/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.9.17/dist/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bs58@4.0.1/index.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/css/styleTrangChu.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
            padding: 20px;
        }

        .form_container {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            max-width: 850px;
            margin: auto;
        }

        .form_title {
            color: #007bff;
            margin-bottom: 30px;
            font-weight: bold;
            text-align: center;
        }

        .form_group label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .form_group input,
        .form_group textarea {
            border-radius: 5px;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ced4da;
            width: 100%;
            margin-bottom: 20px;
        }

        .form_group input[type="file"] {
            padding: 3px;
        }

        .form_group img {
            margin-right: 15px;
            vertical-align: middle;
        }

        .modal-footer {
            padding-top: 20px;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            font-weight: bold;
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .form_style:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        }

        .nft-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5em;
            width: 850px;
        }

        .nft-image {
            width: 200px;
            height: 200px;
            border-radius: 8px;
        }

        .nft-item {
            transition: transform 0.2s;
            /* flex: 1 1 calc(35.333% - 1rem); */
            /* box-sizing: border-box; */
        }

        .nft-item:hover {
            transform: translateY(-5px);
        }

        .nft-card {
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
            width: 250px;
        }

        .vertical-layout {
            display: flex;
            flex-direction: column;
            /* flex-wrap: wrap; */
            gap: 1rem;
        }
    </style>

</head>

<body>
    <div th:replace="fragment/nav :: navFragment"></div>
    <div class="form_container">
        <h1 class="form_title">List and Transfer NFTs</h1>

        <!-- Nhóm phần tử nhập địa chỉ ví -->
        <div class="form_group">
            <label for="wallet-address">Enter Wallet Address:</label>
            <input type="text" class="form_style" id="wallet-address" placeholder="Enter your wallet address" />
        </div>

        <div class="form_group">
            <button id="fetch-nfts" class="btn btn-primary w-100">Fetch NFTs</button>
        </div>

        <!-- Nhóm phần tử nhập địa chỉ ví người nhận -->
        <div class="form_group">
            <label for="to-address">Enter Recipient Wallet Address:</label>
            <input type="text" class="form_style" id="to-address" placeholder="Enter recipient wallet address"
                th:value="${tuyenDungTrans.maViTuyenDung}" />
        </div>

        <!-- Tiêu đề danh sách NFT -->
        <h2 class="form_title">Your NFTs:</h2>

        <!-- Danh sách NFT -->
        <!-- <div id="nft-list" class="vertical-layout"></div> -->
        <div id="nft-list" class="nft-list"></div>
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const connectWallet = async () => {
            try {
                if (window.solana) {
                    const { publicKey } = await window.solana.connect();
                    const publicKeyString = publicKey.toString();
                    document.getElementById("wallet-address").value = publicKeyString;
                } else {
                    console.warn("Solana object not found. Make sure the wallet is installed.");
                }
            } catch (err) {
                console.error("Failed to connect wallet:", err);
            }
        };

        await connectWallet();

        document.getElementById("fetch-nfts").addEventListener("click", () => {
            const address = document.getElementById("wallet-address").value;
            if (address) {
                getNFTs(address);
            } else {
                console.warn("Wallet address not found in input.");
            }
        });

        const getNFTs = (address) => {
            const xKey = "vfEUWHTGcqjMC08l";
            const nftUrl = `https://api.shyft.to/sol/v1/nft/read_all?network=devnet&address=${address}`;

            fetch(nftUrl, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": xKey,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success === true) {
                        renderNFTs(data.result);
                    } else {
                        console.warn("Failed to fetch NFTs.");
                    }
                })
                .catch((err) => {
                    console.warn("Fetch error:", err);
                });
        };

        const renderNFTs = (nfts) => {
            const nftList = document.getElementById("nft-list");
            nftList.innerHTML = "";

            nfts.forEach((nft) => {
                const nftItem = document.createElement("div");
                nftItem.className = "col-md-4 mb-4";

                const nftCard = document.createElement("div");
                nftCard.className = "nft-item nft-card";

                const nftName = document.createElement("h5");
                nftName.className = "card-title";
                nftName.textContent = nft.name;
                nftCard.appendChild(nftName);

                if (nft.image_uri) {
                    const nftImage = document.createElement("img");
                    nftImage.src = nft.image_uri;
                    nftImage.alt = nft.name;
                    nftImage.className = "nft-image mb-3";
                    nftCard.appendChild(nftImage);
                }


                const button1 = document.createElement("button");
                button1.textContent = "Transfer";
                button1.className = "btn btn-outline-primary w-100";
                button1.addEventListener("click", async () => {
                    const tokenAddress = nft.mint;
                    const toAddress = document.getElementById("to-address").value;
                    const myHeaders = new Headers();
                    myHeaders.append("x-api-key", "vfEUWHTGcqjMC08l");
                    myHeaders.append("Content-Type", "application/json");

                    const raw = JSON.stringify({
                        "network": "devnet",
                        "token_address": tokenAddress,
                        "from_address": document.getElementById("wallet-address").value,
                        "to_address": toAddress,
                        "fee_payer": document.getElementById("wallet-address").value
                    });

                    const requestOptions = {
                        method: 'POST',
                        headers: myHeaders,
                        body: raw,
                        redirect: 'follow'
                    };

                    try {
                        const response = await fetch("https://api.shyft.to/sol/v1/nft/transfer_detach", requestOptions);
                        const result = await response.json();

                        if (response.ok && result.success) {
                            console.log("Transfer Request Generated:", result);
                            const { encoded_transaction } = result.result;
                            await sendTransaction(encoded_transaction);
                        } else {
                            console.error("Transfer Error:", result.error || "Unknown error");
                            alert("Transfer Failed: " + (result.error || "Unknown error"));
                        }
                    } catch (error) {
                        console.error("Transfer Error:", error);
                        alert("Transfer Failed. Please try again.");
                    }
                });
                nftCard.appendChild(button1);

                nftItem.appendChild(nftCard);
                nftList.appendChild(nftItem);
            });
        };

        async function sendTransaction(encodedTransaction) {
            try {
                if (window.solana) {
                    const { publicKey } = await window.solana.connect();
                    const transaction = solanaWeb3.Transaction.from(base64ToUint8Array(encodedTransaction));
                    const signature = await window.solana.signAndSendTransaction(transaction);

                    console.log("Transaction Signature:", signature);

                    // Kiểm tra giao dịch đã được xác nhận
                    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"), "confirmed");
                    await connection.confirmTransaction(signature.signature);

                    console.log("Transaction confirmed:", signature.signature);
                    alert("Transaction successful!");
                } else {
                    console.warn("Solana object not found. Make sure the wallet is installed.");
                }
            } catch (error) {
                console.error("Send Transaction Error:", error);
                alert("Failed to send transaction. Please try again.");
            }
        }

        function base64ToUint8Array(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }
    });
</script>

</html>