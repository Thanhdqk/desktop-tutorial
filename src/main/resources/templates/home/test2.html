<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Transfer NFTs</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.16.0/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.8.0/dist/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bs58@4.0.1/index.min.js"></script>
</head>
<style>
    .nft-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
    }

    .nft-image {
        max-width: 200px;
        display: block;
        margin-top: 10px;
    }
</style>

<body>
    <h1>List and Transfer NFTs</h1>

    <label for="wallet-address">Enter Wallet Address:</label>
    <input type="text" id="wallet-address" placeholder="Enter your wallet address" />
    <button id="fetch-nfts">Fetch NFTs</button>

    <h2>Your NFTs:</h2>
    <div id="nft-list"></div>

</body>

<script>
    let wallet;
    let publicKeyString = ""; // Khai báo biến publicKeyString bên ngoài
    console.log(window.PhantomWalletAdapter);
    document.addEventListener("DOMContentLoaded", async () => {
        const connectWallet = async () => {
            try {
                if (window.solana) {
                    wallet = await window.solana.connect();
                    publicKeyString = wallet.publicKey.toString(); // Gán giá trị cho biến publicKeyString
                    console.log(publicKeyString);
                    document.getElementById("wallet-address").value = publicKeyString;
                } else {
                    console.warn("Solana object not found. Make sure the wallet is installed.");
                }
            } catch (err) {
                console.error("Failed to connect wallet:", err);
            }
        };

        await connectWallet();

        document.getElementById("fetch-nfts").addEventListener("click", () => {
            const address = document.getElementById("wallet-address").value;
            if (address) {
                console.log("Public Key:", address);
                getNFTs(address);
            } else {
                console.warn("Wallet address not found in input.");
            }
        });

        const getNFTs = (address) => {
            const xKey = "vfEUWHTGcqjMC08l";
            let nftUrl = `https://api.shyft.to/sol/v1/nft/read_all?network=devnet&address=${address}`;

            fetch(nftUrl, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": xKey,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    if (data.success === true) {
                        renderNFTs(data.result);
                    }
                })
                .catch((err) => {
                    console.warn(err);
                });
        };

        const renderNFTs = (nfts) => {
            const nftList = document.getElementById("nft-list");
            nftList.innerHTML = "";

            nfts.forEach((nft) => {
                const nftItem = document.createElement("div");
                nftItem.className = "nft-item";

                const nftName = document.createElement("p");
                nftName.textContent = nft.name;
                nftItem.appendChild(nftName);

                if (nft.image_uri) {
                    const nftImage = document.createElement("img");
                    nftImage.src = nft.image_uri;
                    nftImage.alt = nft.name;
                    nftImage.className = "nft-image";
                    nftItem.appendChild(nftImage);
                }

                const button1 = document.createElement("button");
                button1.textContent = "Transfer";
                button1.addEventListener("click", async () => {
                    const tokenAddress = nft.mint;
                    const toAddress = "7wfp6apUR8WfHmB4e4LGDqc8JfnuZiDR7NKFXpLzBsgR";
                    const feePayer = publicKeyString;

                    var myHeaders = new Headers();
                    myHeaders.append("x-api-key", "vfEUWHTGcqjMC08l");
                    myHeaders.append("Content-Type", "application/json");

                    var raw = JSON.stringify({
                        "network": "devnet",
                        "token_address": tokenAddress,
                        "from_address": publicKeyString,
                        "to_address": toAddress,
                        "fee_payer": feePayer
                    });

                    var requestOptions = {
                        method: 'POST',
                        headers: myHeaders,
                        body: raw,
                        redirect: 'follow'
                    };

                    try {
                        const response = await fetch("https://api.shyft.to/sol/v1/nft/transfer_detach", requestOptions);
                        const result = await response.json();

                        if (response.ok && result.success) {
                            console.log("Transfer Request Generated:", result);
                            const transactionId = result.transaction_id; // Nhận transaction_id từ phản hồi
                            console.log("Transaction ID:", transactionId);
                            alert("Transfer Successful!");

                            // Xác nhận và hoàn tất giao dịch
                            const network = "devnet";
                            const transactions = [transactionId];
                            await signAndConfirmTransactions(network, transactions, () => console.log("Transaction finalized"));
                        } else {
                            console.error("Transfer Error:", result.error || "Unknown error");
                            alert("Transfer Failed: " + (result.error || "Unknown error"));
                        }
                    } catch (error) {
                        console.error("Transfer Error:", error);
                        alert("Transfer Failed. Please try again.");
                    }
                });
                nftItem.appendChild(button1);

                nftList.appendChild(nftItem);
            });
        };

        async function signAndConfirmTransactions(network, transactions, callback) {
            const { PhantomWalletAdapter } = window.solanaWalletAdapterPhantom;
            const phantom = new PhantomWalletAdapter();
            await phantom.connect();
            const rpcUrl = solanaWeb3.clusterApiUrl(network);
            const connection = new solanaWeb3.Connection(rpcUrl, "confirmed");

            const ret = await confirmTransactionsFromFrontend(connection, transactions, phantom);

            console.log("Finalizing Transaction");
            connection.onSignature(ret[0], callback, 'finalized');
            return ret;
        }

        async function confirmTransactionsFromFrontend(connection, transactions, wallet) {
            const txIds = [];
            for (const transaction of transactions) {
                const txId = await wallet.sendTransaction(transaction, connection);
                txIds.push(txId);
            }
            return txIds;
        }
    });
</script>

</html>