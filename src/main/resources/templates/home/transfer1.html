<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List Transfer NFTs</title>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.16.0/lib/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-phantom@0.9.17/dist/index.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bs58@4.0.1/index.min.js"></script>
</head>
<style>
    .nft-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
    }

    .nft-image {
        max-width: 200px;
        display: block;
        margin-top: 10px;
    }
</style>

<body>
    <h1>List and Transfer NFTs</h1>
    <label for="wallet-address">Enter Wallet Address:</label>
    <input type="text" id="wallet-address" placeholder="Enter your wallet address" />
    <button id="fetch-nfts">Fetch NFTs</button>
    <h2>Your NFTs:</h2>
    <div id="nft-list"></div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const connectWallet = async () => {
            try {
                if (window.solana) {
                    const { publicKey } = await window.solana.connect();
                    const publicKeyString = publicKey.toString();
                    document.getElementById("wallet-address").value = publicKeyString;
                } else {
                    console.warn("Solana object not found. Make sure the wallet is installed.");
                }
            } catch (err) {
                console.error("Failed to connect wallet:", err);
            }
        };

        await connectWallet();

        document.getElementById("fetch-nfts").addEventListener("click", () => {
            const address = document.getElementById("wallet-address").value;
            if (address) {
                getNFTs(address);
            } else {
                console.warn("Wallet address not found in input.");
            }
        });

        const getNFTs = (address) => {
            const xKey = "vfEUWHTGcqjMC08l";
            const nftUrl = `https://api.shyft.to/sol/v1/nft/read_all?network=devnet&address=${address}`;

            fetch(nftUrl, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "x-api-key": xKey,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success === true) {
                        renderNFTs(data.result);
                    } else {
                        console.warn("Failed to fetch NFTs.");
                    }
                })
                .catch((err) => {
                    console.warn("Fetch error:", err);
                });
        };

        const renderNFTs = (nfts) => {
            const nftList = document.getElementById("nft-list");
            nftList.innerHTML = "";

            nfts.forEach((nft) => {
                const nftItem = document.createElement("div");
                nftItem.className = "nft-item";

                const nftName = document.createElement("p");
                nftName.textContent = nft.name;
                nftItem.appendChild(nftName);

                if (nft.image_uri) {
                    const nftImage = document.createElement("img");
                    nftImage.src = nft.image_uri;
                    nftImage.alt = nft.name;
                    nftImage.className = "nft-image";
                    nftItem.appendChild(nftImage);
                }

                const button1 = document.createElement("button");
                button1.textContent = "Transfer";
                button1.addEventListener("click", async () => {
                    const tokenAddress = nft.mint;
                    const toAddress = "7wfp6apUR8WfHmB4e4LGDqc8JfnuZiDR7NKFXpLzBsgR";

                    const myHeaders = new Headers();
                    myHeaders.append("x-api-key", "vfEUWHTGcqjMC08l");
                    myHeaders.append("Content-Type", "application/json");

                    const raw = JSON.stringify({
                        "network": "devnet",
                        "token_address": tokenAddress,
                        "from_address": document.getElementById("wallet-address").value,
                        "to_address": toAddress,
                        "fee_payer": document.getElementById("wallet-address").value
                    });

                    const requestOptions = {
                        method: 'POST',
                        headers: myHeaders,
                        body: raw,
                        redirect: 'follow'
                    };

                    try {
                        const response = await fetch("https://api.shyft.to/sol/v1/nft/transfer_detach", requestOptions);
                        const result = await response.json();

                        if (response.ok && result.success) {
                            console.log("Transfer Request Generated:", result);
                            const { encoded_transaction } = result.result;
                            await sendTransaction(encoded_transaction);
                        } else {
                            console.error("Transfer Error:", result.error || "Unknown error");
                            alert("Transfer Failed: " + (result.error || "Unknown error"));
                        }
                    } catch (error) {
                        console.error("Transfer Error:", error);
                        alert("Transfer Failed. Please try again.");
                    }
                });
                nftItem.appendChild(button1);

                nftList.appendChild(nftItem);
            });
        };

        async function sendTransaction(encodedTransaction) {
            try {
                if (window.solana) {
                    const { publicKey } = await window.solana.connect();
                    const transaction = solanaWeb3.Transaction.from(base64ToUint8Array(encodedTransaction));
                    const signature = await window.solana.signAndSendTransaction(transaction);

                    console.log("Transaction Signature:", signature);

                    // Kiểm tra giao dịch đã được xác nhận
                    const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"), "confirmed");
                    await connection.confirmTransaction(signature.signature);

                    console.log("Transaction confirmed:", signature.signature);
                    alert("Transaction successful!");
                } else {
                    console.warn("Solana object not found. Make sure the wallet is installed.");
                }
            } catch (error) {
                console.error("Send Transaction Error:", error);
                alert("Failed to send transaction. Please try again.");
            }
        }

        function base64ToUint8Array(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }
    });
</script>

</html>